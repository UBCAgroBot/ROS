# Checks for merging PR, includes linting
name: Integration pipeline
run-name: Integration pipeline triggered by ${{ github.actor }} 

on:
  pull_request:

  workflow_dispatch:
    inputs:
      delivery: 
        description: 'Would you like to update the official image?'
        required: false
        default: true
        type: boolean
      deployment:
        description: 'Would you like to run unit and benchmarking tests?'
        required: false
        default: true
        type: boolean

jobs:
  integration:
    runs-on: self-hosted
    permissions:
      checks: write
      pull-requests: write
    id: integration
    steps:
      - run: echo "The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "The name of your branch is ${{ github.head_ref }} and your repository is ${{ github.repository }}."
      
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
      
      - name: Print branch
        run: |
          echo "Checked out branch: ${{ github.head_ref }}"

      - name: Show directory contents
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
      
      - name: List files in the repository
        run: |
          echo "github workspace folder"
          ls ${{ github.workspace }}

      - name: Check current directory
        run: pwd

      - name: List files in current directory
        run: ls -la

      - name: List root directory
        run: ls -la /

      - name: List runner's work directory
        run: ls -la /home/runner/work

      - name: List runner's temp directory
        run: ls -la /home/runner/_temp

      - name: List runner's tool directory
        run: ls -la /home/runner/_tool

      - name: List GitHub workspace directory
        run: ls -la ${{ github.workspace }}

      - name: Show environment variables
        run: env

      # - name: C++ lint
      #   uses: cpp-linter/cpp-linter-action@v2
      #   id: cpp_linter
      #   with:
      #     style: "file"
      #     tidy-checks: ""
      #     thread-comments: ${{ github.event_name == 'pull_request' && 'update' }}

      # - name: Lint with pylint
      #   run: |
      #     pylint --disable=C0301 --disable=C0326 *.py
      #     if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      # - name: Lint with flake8
      #   run: |
      #     # stop the build if there are Python syntax errors or undefined names
      #     flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      #     # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
      #     flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      # - name: Check for linting errors
      #   id: lint-check
      #   run: |
      #     if [ -f lint-results.txt ]; then
      #       echo "Linting issues found"
      #       cat lint-results.txt
      #       exit 1
      #     else
      #       echo "No linting issues found"
      #     fi

      # - name: Compile
      #   run: |
      #     cd /ros_ws
      #     rosdep install --from-paths src -y --ignore-src
      #     colcon build --packages-select custom_interface
      #     colcon build --packages-select node_test
      #     . install/setup.bash

      # - name: Test run
      #   run: |
      #     ros2 run node_test jetson_node

      - name: Update pull request
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          if [[ $(git status --porcelain) ]]; then
            git add .
            git commit -m "Auto-fix lint issues"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No lint fixes applied, nothing to commit."
          fi
      
      - run: echo ${{ github.event.inputs.delivery }}
      - run: echo ${{ inputs.delivery }}
      - run: echo ${{ github.event.inputs.deployment }}
      - run: echo ${{ inputs.deployment }}

  # These are only triggered through workflow dispatch
  delivery:
    if: ${{ github.event.inputs.delivery }}
    run: echo "this was detected successfully as a boolean (delivery)"
    # uses: ./.github/workflows/delivery.yml
    # with:
    #   branch: {{ github.head_ref }}
    #   deployment: {{ github.events.inputs.deployment }}

  deployment:
    if: ${{ inputs.deployment }}
    run: echo "this was detected successfully as boolean (deployment)"
    # needs: delivery
    # uses: ./.github/workflows/deployment.yml
    # with: 
    #   container_branch: {{ github.head_ref }}
    #   container_version: {{ needs.delivery.outputs.version }}